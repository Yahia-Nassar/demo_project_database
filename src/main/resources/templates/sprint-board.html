<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Sprint Board</title>
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
<div class="page">
    <header class="page-header">
        <div>
            <h1 class="page-title">Sprint Board</h1>
            <p class="muted">Move work across the workflow and keep assignees updated.</p>
        </div>
        <div th:replace="fragments/nav :: nav"></div>
    </header>

    <p th:if="${param.error}" class="error">
        <span th:if="${param.error[0] == 'conflict'}">Another user updated this task. Please refresh and try again.</span>
        <span th:if="${param.error[0] == 'invalid_status'}">Unable to change status. Please try again.</span>
    </p>

    <div id="board-updates" class="notice" style="display:none;"></div>

    <div class="card" style="margin-bottom: 16px;">
        <form method="get" action="/board/sprint" class="form-row">
            <input type="text" name="query" th:value="${query}" placeholder="Search task or story" class="input" />
            <select name="assigneeId" class="input">
                <option value="">All assignees</option>
                <option th:each="dev : ${developers}"
                        th:value="${dev.id}"
                        th:text="${dev.email}"
                        th:selected="${assigneeId != null and assigneeId == dev.id}">
                </option>
            </select>
            <select name="status" class="input">
                <option value="">All statuses</option>
                <option th:each="status : ${T(com.example.demo.task.TaskStatus).values()}"
                        th:value="${status}"
                        th:text="${status}"
                        th:selected="${statusFilter != null and statusFilter == status}">
                </option>
            </select>
            <button type="submit" class="btn btn-primary">Filter</button>
        </form>
        <form th:if="${#authorization.expression('hasRole(''PO'')') and !stories.isEmpty()}"
              th:action="@{/tasks/story}"
              method="post"
              class="form-row"
              style="margin-top: 12px;">
            <select name="storyId"
                    class="input">
                <option th:each="story : ${stories}"
                        th:value="${story.id}"
                        th:text="${story.title}">
                </option>
            </select>
            <input type="text" name="title" placeholder="New task title" class="input" required />
            <button type="submit" class="btn btn-primary">Add task</button>
        </form>
        <p class="muted" th:if="${#authorization.expression('hasRole(''PO'')') and stories.isEmpty()}">
            Move a story to Sprint before creating tasks.
        </p>
    </div>

    <div class="board">
        <div th:each="entry : ${columns}" class="board-column">
            <div class="form-row" style="justify-content: space-between;">
                <h2 th:text="${entry.key}">Status</h2>
                <span class="status-tag"
                      th:classappend="${entry.key.name() == 'DONE'} ? ' status-done' : (${entry.key.name() == 'BLOCKED'} ? ' status-blocked' : '')"
                      th:text="${entry.key}">Status</span>
            </div>

            <div th:each="task : ${entry.value}" class="board-card">
                <div class="form-row" style="justify-content: space-between;">
                    <strong th:text="${task.title}">Task title</strong>
                    <form th:action="@{/tasks/{id}/edit(id=${task.id})}" method="get">
                        <button type="submit" class="btn btn-link">Edit</button>
                    </form>
                </div>
                <div class="muted" th:text="${task.story.title}">Story title</div>
                <div class="badge-group" th:if="${!task.assignees.isEmpty()}">
                    <span class="badge" th:each="assignee : ${task.assignees}" th:text="${assignee.email}"></span>
                </div>
                <div class="form-row" style="margin-top: 8px;">
                    <span class="muted"
                          th:text="${'Priority: ' + (task.priority != null ? task.priority : '—')}"></span>
                    <span class="muted"
                          th:text="${'Estimate: ' + (task.estimateHours != null ? task.estimateHours : '—') + 'h'}"></span>
                    <span class="muted"
                          th:text="${'Actual: ' + (task.actualHours != null ? task.actualHours : '—') + 'h'}"></span>
                </div>

                <form th:action="@{/tasks/{id}/assign(id=${task.id})}" method="post" class="form-stack" style="margin-top: 10px;">
                    <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
                    <label class="muted">Assignees</label>
                    <select name="assignees" multiple size="3" class="input">
                        <option th:each="dev : ${developers}"
                                th:value="${dev.id}"
                                th:text="${dev.email}"
                                th:selected="${task.assignees.contains(dev)}">
                        </option>
                    </select>
                    <button type="submit" class="btn btn-outline">Save assignees</button>
                </form>

                <form th:action="@{/tasks/{id}/status(id=${task.id})}"
                      method="post"
                      class="form-row"
                      style="margin-top: 10px;">
                    <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
                    <select name="status" class="input">
                        <option th:each="statusOption : ${T(com.example.demo.task.TaskStatus).values()}"
                                th:value="${statusOption.name()}"
                                th:text="'Move to ' + ${statusOption}"
                                th:selected="${normalizedStatuses[task.id] == statusOption}">
                        </option>
                    </select>
                    <button type="submit" class="btn btn-primary">Update status</button>
                </form>

                <form th:action="@{/tasks/{id}/status(id=${task.id})}" method="post" class="form-row"
                      style="margin-top: 8px;">
                    <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
                    <input type="hidden" name="status" th:value="${entry.key.name() == 'DONE' ? 'TODO' : 'DONE'}" />
                    <button type="submit" class="btn btn-outline"
                            th:text="${entry.key.name() == 'DONE' ? 'Mark incomplete' : 'Mark complete'}">
                        Mark complete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const boardUpdates = document.getElementById('board-updates');
    const boardSource = new EventSource('/sse/board');
    boardSource.addEventListener('board', () => {
        boardUpdates.style.display = 'block';
        boardUpdates.textContent = 'Board updated. Refreshing...';
        window.location.reload();
    });
</script>

</body>
</html>