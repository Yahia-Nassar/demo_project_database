<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Sprint Board</title>
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
<div class="page">
    <header class="page-header">
        <div>
            <h1 class="page-title">Sprint Board</h1>
            <p class="muted">Move work across the workflow and keep assignees updated.</p>
        </div>
        <div class="nav-links">
            <a href="/po/dashboard">PO Dashboard</a>
            <a href="/stories/backlog">Backlog</a>
            <a href="/notifications">Notifications</a>
            <a href="/profile">My Profile</a>
            <a href="/reports/estimates">Estimate Report</a>
        </div>
    </header>

    <p th:if="${param.error}" class="error">
        Another user updated this task. Please refresh and try again.
    </p>

    <div id="board-updates" class="notice" style="display:none;"></div>

    <div class="card" style="margin-bottom: 16px;">
        <form method="get" action="/board/sprint" class="form-row">
            <input type="text" name="query" th:value="${query}" placeholder="Search task or story" class="input" />
            <select name="assigneeId" class="input">
                <option value="">All assignees</option>
                <option th:each="dev : ${developers}"
                        th:value="${dev.id}"
                        th:text="${dev.email}"
                        th:selected="${assigneeId != null and assigneeId == dev.id}">
                </option>
            </select>
            <select name="status" class="input">
                <option value="">All statuses</option>
                <option th:each="status : ${T(com.example.demo.task.TaskStatus).values()}"
                        th:value="${status}"
                        th:text="${status}"
                        th:selected="${statusFilter != null and statusFilter == status}">
                </option>
            </select>
            <button type="submit" class="btn btn-primary">Filter</button>
        </form>
    </div>

    <div class="board">
        <div th:each="entry : ${columns}" class="board-column">
            <div class="form-row" style="justify-content: space-between;">
                <h2 th:text="${entry.key}">Status</h2>
                <span class="status-tag"
                      th:classappend="${entry.key.name() == 'DONE'} ? ' status-done' : (${entry.key.name() == 'BLOCKED'} ? ' status-blocked' : '')"
                      th:text="${entry.key}">Status</span>
            </div>

            <div th:each="task : ${entry.value}" class="board-card">
                <div class="form-row" style="justify-content: space-between;">
                    <strong th:text="${task.title}">Task title</strong>
                    <a th:href="@{/tasks/{id}/edit(id=${task.id})}" class="btn btn-link">Edit</a>
                </div>
                <div class="muted" th:text="${task.story.title}">Story title</div>
                <div class="badge-group" th:if="${!task.assignees.isEmpty()}">
                    <span class="badge" th:each="assignee : ${task.assignees}" th:text="${assignee.email}"></span>
                </div>
                <div class="form-row" style="margin-top: 8px;">
                    <span class="muted" th:text="'Estimate: ' + (task.estimateHours != null ? task.estimateHours : '—') + 'h'"></span>
                    <span class="muted" th:text="'Actual: ' + (task.actualHours != null ? task.actualHours : '—') + 'h'"></span>
                </div>

                <form th:action="@{/tasks/{id}/assign(id=${task.id})}" method="post" class="form-stack" style="margin-top: 10px;">
                    <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
                    <label class="muted">Assignees</label>
                    <select name="assignees" multiple size="3" class="input">
                        <option th:each="dev : ${developers}"
                                th:value="${dev.id}"
                                th:text="${dev.email}"
                                th:selected="${task.assignees.contains(dev)}">
                        </option>
                    </select>
                    <button type="submit" class="btn btn-outline">Save assignees</button>
                </form>

                <div class="form-row" style="margin-top: 10px;">
                    <form th:each="nextStatus : ${transitions[task.id]}"
                          th:action="@{/tasks/{id}/status(id=${task.id})}"
                          method="post">
                        <input type="hidden" name="status" th:value="${nextStatus}"/>
                        <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
                        <button type="submit" class="btn btn-primary"
                                th:text="${normalizedStatuses[task.id].name() == 'DONE' and nextStatus.name() == 'IN_PROGRESS'} ? 'Mark Incomplete' : 'Move to ' + nextStatus">
                            Move
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const boardUpdates = document.getElementById('board-updates');
    const boardSource = new EventSource('/sse/board');
    boardSource.addEventListener('board', () => {
        boardUpdates.style.display = 'block';
        boardUpdates.textContent = 'Board updated. Refreshing...';
        window.location.reload();
    });
</script>

</body>
</html>