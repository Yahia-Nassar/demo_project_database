<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Notifications</title>
    <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
<div class="page">
    <header class="page-header">
        <div>
            <h1 class="page-title">Notifications</h1>
            <p class="muted" th:text="'Unread: ' + ${unreadCount}"></p>
        </div>
        <div th:replace="fragments/nav :: nav"></div>
    </header>

    <div id="notification-stream" class="notice" style="display:none; margin-bottom: 12px;"></div>

    <div class="card">
        <form th:action="@{/notifications/delete-read}" method="post" style="margin-bottom: 12px;">
            <button type="submit" class="btn btn-outline">Delete read notifications</button>
        </form>
        <div th:each="notification : ${notifications}" class="card" style="margin-bottom: 12px;">
            <div class="form-row" style="justify-content: space-between;">
                <div>
                    <strong th:text="${notification.message}"></strong>
                    <div class="muted" th:text="${notification.createdAt}"></div>
                </div>
                <span class="pill" th:if="${notification.readAt == null}">Unread</span>
            </div>
            <div class="form-row" style="margin-top: 8px;">
                <form th:action="@{/notifications/{id}/read(id=${notification.id})}"
                      method="post">
                    <button type="submit" class="btn btn-outline">Mark read</button>
                </form>
                <form th:action="@{/notifications/{id}/delete(id=${notification.id})}"
                      method="post">
                    <button type="submit" class="btn btn-outline">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const notificationStream = document.getElementById('notification-stream');
    const notificationSource = new EventSource('/sse/notifications');
    notificationSource.addEventListener('notification', (event) => {
        notificationStream.style.display = 'block';
        notificationStream.textContent = 'New notification: ' + event.data;
    });
</script>

</body>
</html>